name: Publish packages

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: Name of the package to publish (leave empty to publish all packages)
        required: false
        type: string
        default: ""

jobs:
  publish:
    name: Publish packages
    permissions:
      contents: write
      pull-requests: write
    runs-on: shipfox-2vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Install Nix dependencies
        uses: ./.github/actions/nix
      - name: Install NodeJS dependencies
        uses: ./.github/actions/pnpm
        with:
          ignore-scripts: true
      - name: Bump version
        shell: nix develop --command bash {0}
        run: pnpm changeset version
      - name: Format code
        shell: nix develop --command bash {0}
        run: pnpm turbo run --affected check -- --fix
      - name: Build packages
        shell: nix develop --command bash {0}
        run: pnpm turbo run --affected build type
      - name: Publish specific package
        if: inputs.package_name != ''
        shell: nix develop --command bash {0}
        run: pnpm publish --access public --no-git-checks --filter ${{ inputs.package_name }}
        env:
          NPM_ACCESS_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
      - name: Publish all packages
        if: inputs.package_name == ''
        shell: nix develop --command bash {0}
        run: pnpm publish --access public --no-git-checks --recursive
        env:
          NPM_ACCESS_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
      - uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6
        with:
          gpg_private_key: ${{ secrets.DEPLOY_BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.DEPLOY_BOT_GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
        with:
          token: ${{ secrets.DEPLOY_BOT_PERSONAL_ACCESS_TOKEN }}
          committer: shipfox-deploy-bot <deploy-bot@shipfox.io>
          author: shipfox-deploy-bot <deploy-bot@shipfox.io>
          commit-message: New release
          title: New release
          body: A new release of the packages was created.
          branch: release
          branch-suffix: short-commit-hash
